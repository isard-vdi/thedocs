



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="IsardVDI Technical & Practical info (Escola del Treball Barcelona)">
      
      
        <link rel="canonical" href="http://thedocs.isardvdi.com/setups/virtualization/gpu_sriov/">
      
      
        <meta name="author" content="IsardVDI">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.2">
    
    
      
        <title>GPU SRIOV - IsardVDI Technical docs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.8d40d89b.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#gpu-sriov-with-a-firepro-s7150-graphics-card" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="http://thedocs.isardvdi.com" title="IsardVDI Technical docs" class="md-header-nav__button md-logo">
          
            <img src="../../../images/logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                IsardVDI Technical docs
              </span>
              <span class="md-header-nav__topic">
                GPU SRIOV
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/isard-vdi/thedocs/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      isard-vdi/thedocs
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../images/logo.svg" width="48" height="48">
      
    </span>
    IsardVDI Technical docs
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/isard-vdi/thedocs/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      isard-vdi/thedocs
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Storage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Storage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../storage/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../storage/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../storage/raid/" title="Raid" class="md-nav__link">
      Raid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../storage/drbd/" title="DRBD" class="md-nav__link">
      DRBD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5">
    
    <label class="md-nav__link" for="nav-2-5">
      Cache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Cache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../storage/cache/eio/" title="EiO" class="md-nav__link">
      EiO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../storage/cache/writeboost/" title="Writeboost" class="md-nav__link">
      Writeboost
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Networking
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Networking
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../networking/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../networking/tools/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../networking/bondings/" title="Bondings" class="md-nav__link">
      Bondings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../networking/10g/" title="TenGigabit" class="md-nav__link">
      TenGigabit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../networking/40g/" title="FortyGigabit" class="md-nav__link">
      FortyGigabit
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Clusters & HA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Clusters & HA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../clusters/pacemaker/" title="Pacemaker" class="md-nav__link">
      Pacemaker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../clusters/stonith/" title="Stonith" class="md-nav__link">
      Stonith
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-3" type="checkbox" id="nav-4-3">
    
    <label class="md-nav__link" for="nav-4-3">
      OCF resources
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-3">
        OCF resources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../clusters/ocf/eio/" title="EnhanceIO" class="md-nav__link">
      EnhanceIO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../clusters/ocf/writeboost/" title="Writeboost" class="md-nav__link">
      Writeboost
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../clusters/live-migration/" title="Live Migration" class="md-nav__link">
      Live Migration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Virtualization
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Virtualization
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../virtualization/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../virtualization/disks/" title="Disk images" class="md-nav__link">
      Disk images
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../virtualization/gpus/" title="GPUs" class="md-nav__link">
      GPUs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Setups
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Setups
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-1" type="checkbox" id="nav-6-1">
    
    <label class="md-nav__link" for="nav-6-1">
      HA Clusters
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-1">
        HA Clusters
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ha/active_passive/" title="Active-Pasive" class="md-nav__link">
      Active-Pasive
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ha/active_active/" title="Active-Active" class="md-nav__link">
      Active-Active
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6-2" type="checkbox" id="nav-6-2" checked>
    
    <label class="md-nav__link" for="nav-6-2">
      Virtualization
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-6-2">
        Virtualization
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        GPU SRIOV
      </label>
    
    <a href="./" title="GPU SRIOV" class="md-nav__link md-nav__link--active">
      GPU SRIOV
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-modify-the-bios" title="1- Modify the BIOS" class="md-nav__link">
    1- Modify the BIOS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-kernel-compilation" title="2- Kernel compilation" class="md-nav__link">
    2- Kernel compilation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-activate-the-deb-src-apt-repositories-to-be-able-to-download-the-kernel-source" title="2.1- Activate the deb-src apt repositories to be able to download the Kernel source" class="md-nav__link">
    2.1- Activate the deb-src apt repositories to be able to download the Kernel source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-now-we-need-to-download-the-required-packages-to-be-able-to-unpack-the-kernel-we-need-to-download-the-repo-that-contains-the-gim-module-sources-and-the-paches-to-apply" title="2.2- Now we need to download the required packages to be able to unpack the kernel. We need to download the repo that contains the gim module sources and the paches to apply" class="md-nav__link">
    2.2- Now we need to download the required packages to be able to unpack the kernel. We need to download the repo that contains the gim module sources and the paches to apply
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-now-we-install-all-the-packages-required-to-compile-the-kernel" title="2.3- Now we install all the packages required to compile the Kernel" class="md-nav__link">
    2.3- Now we install all the packages required to compile the Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-kernel-preparation-and-patch-installation" title="2.4- Kernel preparation and patch installation" class="md-nav__link">
    2.4- Kernel preparation and patch installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-kernel-compilation" title="2.5- Kernel compilation" class="md-nav__link">
    2.5- Kernel compilation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-new-kernel-installation" title="2.6- New Kernel installation" class="md-nav__link">
    2.6- New Kernel installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-grub-preparation" title="3- GRUB preparation" class="md-nav__link">
    3- GRUB preparation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-add-the-module-amdgpu-to-the-blacklist-well-use-the-gim-module" title="3.1- Add the module amdgpu to the blacklist (we'll use the gim module)" class="md-nav__link">
    3.1- Add the module amdgpu to the blacklist (we'll use the gim module)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-edit-the-default-grub-configuration-in-order-to-enable-iommu" title="3.2- Edit the default GRUB configuration in order to  enable  IOMMU" class="md-nav__link">
    3.2- Edit the default GRUB configuration in order to  enable  IOMMU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-gim-module-compilation" title="4- gim module compilation" class="md-nav__link">
    4- gim module compilation
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Utilities
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Utilities
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../utilities/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../utilities/grafana/" title="Grafana" class="md-nav__link">
      Grafana
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../utilities/fio/" title="fio" class="md-nav__link">
      fio
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../about/license/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-modify-the-bios" title="1- Modify the BIOS" class="md-nav__link">
    1- Modify the BIOS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-kernel-compilation" title="2- Kernel compilation" class="md-nav__link">
    2- Kernel compilation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-activate-the-deb-src-apt-repositories-to-be-able-to-download-the-kernel-source" title="2.1- Activate the deb-src apt repositories to be able to download the Kernel source" class="md-nav__link">
    2.1- Activate the deb-src apt repositories to be able to download the Kernel source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-now-we-need-to-download-the-required-packages-to-be-able-to-unpack-the-kernel-we-need-to-download-the-repo-that-contains-the-gim-module-sources-and-the-paches-to-apply" title="2.2- Now we need to download the required packages to be able to unpack the kernel. We need to download the repo that contains the gim module sources and the paches to apply" class="md-nav__link">
    2.2- Now we need to download the required packages to be able to unpack the kernel. We need to download the repo that contains the gim module sources and the paches to apply
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-now-we-install-all-the-packages-required-to-compile-the-kernel" title="2.3- Now we install all the packages required to compile the Kernel" class="md-nav__link">
    2.3- Now we install all the packages required to compile the Kernel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-kernel-preparation-and-patch-installation" title="2.4- Kernel preparation and patch installation" class="md-nav__link">
    2.4- Kernel preparation and patch installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-kernel-compilation" title="2.5- Kernel compilation" class="md-nav__link">
    2.5- Kernel compilation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-new-kernel-installation" title="2.6- New Kernel installation" class="md-nav__link">
    2.6- New Kernel installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-grub-preparation" title="3- GRUB preparation" class="md-nav__link">
    3- GRUB preparation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-add-the-module-amdgpu-to-the-blacklist-well-use-the-gim-module" title="3.1- Add the module amdgpu to the blacklist (we'll use the gim module)" class="md-nav__link">
    3.1- Add the module amdgpu to the blacklist (we'll use the gim module)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-edit-the-default-grub-configuration-in-order-to-enable-iommu" title="3.2- Edit the default GRUB configuration in order to  enable  IOMMU" class="md-nav__link">
    3.2- Edit the default GRUB configuration in order to  enable  IOMMU
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-gim-module-compilation" title="4- gim module compilation" class="md-nav__link">
    4- gim module compilation
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/isard-vdi/thedocs/edit/master/docs/setups/virtualization/gpu_sriov.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="gpu-sriov-with-a-firepro-s7150-graphics-card">GPU SRIOV with a FirePro S7150 graphics card<a class="headerlink" href="#gpu-sriov-with-a-firepro-s7150-graphics-card" title="Permanent link">&para;</a></h1>
<p>In order to archieve a GPU SRIOV with a FirePro S7150 card, we'll need to have a <strong>kernel 4.4</strong> of an <strong>Ubuntu 16.04 server</strong>. During the installation process, we'll need to make sure that the virtualization option is checked on.  </p>
<p><strong>TODO</strong>:
- Check if it can be made with other distros or kernels</p>
<h2 id="1-modify-the-bios">1- Modify the BIOS<a class="headerlink" href="#1-modify-the-bios" title="Permanent link">&para;</a></h2>
<p>The first step is going to be modify the BIOS. We'll need to reset it to defaults, change the boot method to <strong>legacy</strong>, activate all the parameters related with <strong>virtualization</strong> and, finally, enable <strong>SRIOV</strong>. If the motherboard doesn't have this last option, the whole thing is not going to work. We'll have to change the <strong>main graphics</strong> card to the <strong>onboard</strong> one, since the FirePro S7150 doesn't have a video output. (<code>IntelRCSetup &gt; Miscellanious Configuration &gt; Active Video [Onboard Device]</code>)</p>
<h2 id="2-kernel-compilation">2- Kernel compilation<a class="headerlink" href="#2-kernel-compilation" title="Permanent link">&para;</a></h2>
<p>In order to use the graphics cards and all its cores, we'll have to recompile the Linux Kernel, modifying some values and applying some paches.</p>
<h3 id="21-activate-the-deb-src-apt-repositories-to-be-able-to-download-the-kernel-source">2.1- Activate the <code>deb-src</code> apt repositories to be able to download the Kernel source<a class="headerlink" href="#21-activate-the-deb-src-apt-repositories-to-be-able-to-download-the-kernel-source" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>vim /etc/apt/sources.list
----
<span class="c1"># See http://help.ubuntu.com/community/UpgradeNotes for how to upgrade to</span>
<span class="c1"># newer versions of the distribution.</span>
deb http://es.archive.ubuntu.com/ubuntu/ xenial main restricted
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial main restricted

<span class="c1">## Major bug fix updates produced after the final release of the</span>
<span class="c1">## distribution.</span>
deb http://es.archive.ubuntu.com/ubuntu/ xenial-updates main restricted
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial-updates main restricted

<span class="c1">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu</span>
<span class="c1">## team. Also, please note that software in universe WILL NOT receive any</span>
<span class="c1">## review or updates from the Ubuntu security team.</span>
deb http://es.archive.ubuntu.com/ubuntu/ xenial universe
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial universe
deb http://es.archive.ubuntu.com/ubuntu/ xenial-updates universe
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial-updates universe

<span class="c1">## N.B. software from this repository is ENTIRELY UNSUPPORTED by the Ubuntu </span>
<span class="c1">## team, and may not be under a free licence. Please satisfy yourself as to </span>
<span class="c1">## your rights to use the software. Also, please note that software in </span>
<span class="c1">## multiverse WILL NOT receive any review or updates from the Ubuntu</span>
<span class="c1">## security team.</span>
deb http://es.archive.ubuntu.com/ubuntu/ xenial multiverse
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial multiverse
deb http://es.archive.ubuntu.com/ubuntu/ xenial-updates multiverse
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial-updates multiverse

<span class="c1">## N.B. software from this repository may not have been tested as</span>
<span class="c1">## extensively as that contained in the main release, although it includes</span>
<span class="c1">## newer versions of some applications which may provide useful features.</span>
<span class="c1">## Also, please note that software in backports WILL NOT receive any review</span>
<span class="c1">## or updates from the Ubuntu security team.</span>
deb http://es.archive.ubuntu.com/ubuntu/ xenial-backports main restricted universe multiverse
deb-src http://es.archive.ubuntu.com/ubuntu/ xenial-backports main restricted universe multiverse

<span class="c1">## Uncomment the following two lines to add software from Canonical&#39;s</span>
<span class="c1">## &#39;partner&#39; repository.</span>
<span class="c1">## This software is not part of Ubuntu, but is offered by Canonical and the</span>
<span class="c1">## respective vendors as a service to Ubuntu users.</span>
<span class="c1"># deb http://archive.canonical.com/ubuntu xenial partner</span>
<span class="c1"># deb-src http://archive.canonical.com/ubuntu xenial partner</span>

deb http://security.ubuntu.com/ubuntu xenial-security main restricted
deb-src http://security.ubuntu.com/ubuntu xenial-security main restricted
deb http://security.ubuntu.com/ubuntu xenial-security universe
deb-src http://security.ubuntu.com/ubuntu xenial-security universe
deb http://security.ubuntu.com/ubuntu xenial-security multiverse
deb-src http://security.ubuntu.com/ubuntu xenial-security multiverse
----
apt update <span class="o">&amp;&amp;</span> apt upgrade -y
reboot <span class="c1"># !!!! THIS REBOOT IS NEEDED !!!!</span>
</pre></div>


<h3 id="22-now-we-need-to-download-the-required-packages-to-be-able-to-unpack-the-kernel-we-need-to-download-the-repo-that-contains-the-gim-module-sources-and-the-paches-to-apply">2.2- Now we need to download the required packages to be able to unpack the kernel. We need to download the repo that contains the <code>gim</code> module sources and the paches to apply<a class="headerlink" href="#22-now-we-need-to-download-the-required-packages-to-be-able-to-unpack-the-kernel-we-need-to-download-the-repo-that-contains-the-gim-module-sources-and-the-paches-to-apply" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>apt install -y dpkg-dev
apt <span class="nb">source</span> linux-image-<span class="k">$(</span>uname -r<span class="k">)</span>
git clone https://github.com/GPUOpen-LibrariesAndSDKs/MxGPU-Virtualization
</pre></div>


<h3 id="23-now-we-install-all-the-packages-required-to-compile-the-kernel">2.3- Now we install all the packages required to compile the Kernel<a class="headerlink" href="#23-now-we-install-all-the-packages-required-to-compile-the-kernel" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>apt build-dep linux-image-<span class="k">$(</span>uname -r<span class="k">)</span>
apt install libncurses5 libncurses5-dev
</pre></div>


<h3 id="24-kernel-preparation-and-patch-installation">2.4- Kernel preparation and patch installation<a class="headerlink" href="#24-kernel-preparation-and-patch-installation" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> linux-4.4.0
make oldconfig
make menuconfig
&gt; Enable loadable module support ---&gt;
&gt;&gt; <span class="o">[</span> <span class="o">]</span> Module signature verification <span class="c1"># This has to be unchecked. After that, we can save and exit</span>
patch &lt; ../MxGPU-Virtualization/patch/0001-Added-legacy-endpoint-type-to-sriov-for-ubuntu-4.4.0-75-generic.diff
File to patch: ./drivers/pci/iov.c <span class="c1"># We need to specify the path of the file we want to patch</span>
patch &lt; ../MxGPU-Virtualization/patch/0002-add-pci-io-access-cap-for-ubuntu-4.4.0-75-generic.diff
File to patch: ./drivers/vfio/pci/vfio_pci_config.c <span class="c1"># We need to specify the path of the file we want to patch</span>
</pre></div>


<h3 id="25-kernel-compilation">2.5- Kernel compilation<a class="headerlink" href="#25-kernel-compilation" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>make -j &lt;number of threads that the CPU has&gt; deb-pkg <span class="nv">LOCALVERSION</span><span class="o">=</span>-vm-firepro
</pre></div>


<h3 id="26-new-kernel-installation">2.6- New Kernel installation<a class="headerlink" href="#26-new-kernel-installation" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> ..
dpkg -i *.deb
</pre></div>


<h2 id="3-grub-preparation">3- GRUB preparation<a class="headerlink" href="#3-grub-preparation" title="Permanent link">&para;</a></h2>
<h3 id="31-add-the-module-amdgpu-to-the-blacklist-well-use-the-gim-module">3.1- Add the module <code>amdgpu</code> to the blacklist (we'll use the <code>gim</code> module)<a class="headerlink" href="#31-add-the-module-amdgpu-to-the-blacklist-well-use-the-gim-module" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>vim /etc/modprobe.d/blacklist.conf
----
...
<span class="c1"># AMD GPU (we&#39;ll use the gim module)</span>
blacklist amdgpu
----
update-initramfs -u
</pre></div>


<h3 id="32-edit-the-default-grub-configuration-in-order-to-enable-iommu">3.2- Edit the default GRUB configuration in order to  enable  IOMMU<a class="headerlink" href="#32-edit-the-default-grub-configuration-in-order-to-enable-iommu" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>vim /etc/default/grub
----
...
<span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;quiet intel_iommu=on&quot;</span>
...
----
update-grub
</pre></div>


<h2 id="4-gim-module-compilation">4- <code>gim</code> module compilation<a class="headerlink" href="#4-gim-module-compilation" title="Permanent link">&para;</a></h2>
<p>The <code>gim</code> module is the module that we're going to use in order to control the graphics card. </p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> MxGPU-Virtualization
./gim.sh
mkdir /lib/modules/&lt;firepro version&gt;/misc
mv /lib/modules/&lt;firepro version/GIM /lib/modules/&lt;firepro version&gt;/misc/gim
depmod
nano /etc/modules <span class="c1"># Make the module load on boot</span>
----
...
gim
...
----
</pre></div>


<p>Once it's compiled, we need to execute the following:</p>
<div class="codehilite"><pre><span></span>reboot <span class="c1"># To apply all the GRUB configuration</span>
modprobe gim
modprobe -r gim
nano /etc/gim_config <span class="c1"># It needs to be nano, the vi command isn&#39;t going to work</span>
----
...
<span class="nv">vf_num</span><span class="o">=</span><span class="m">16</span> <span class="c1"># This is going to activate the 16 cores of the GPU</span>
...
----
modprobe gim
dmesg <span class="c1"># Finally, we need to check that the gim module has successfully been loaded, without errors</span>
lspci -vvv <span class="c1"># We can now see that the FirePro S7150 has all the 16 cores activated</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../ha/active_active/" title="Active-Active" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Active-Active
              </span>
            </div>
          </a>
        
        
          <a href="../../../utilities/monitoring/" title="Monitoring" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Monitoring
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="http://www.isardvdi.com">IsardVDI</a>.
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.b438e6c5.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>